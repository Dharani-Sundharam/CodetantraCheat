<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CodeTantra Automation</title>
    <link rel="stylesheet" href="assets/style-dark.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <div class="logo">CT</div>
                <span class="brand-name">CodeTantra Automation</span>
            </div>
            <div class="nav-links">
                <span id="userEmail" class="user-email"></span>
                <button onclick="logout()" class="btn btn-outline">Logout</button>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="container">
            <h1>Dashboard</h1>
            
            <div class="dashboard-grid">
                <!-- Credits Card -->
                <div class="dashboard-card credits-card">
                    <h2>Your Credits</h2>
                    <div class="credits-display">
                        <span id="creditsBalance" class="credits-number">0</span>
                        <span class="credits-label">credits</span>
                    </div>
                    <p class="credits-info">Each code completion uses 5 credits, other problems use 3 credits</p>
                </div>

                <!-- Referral Card -->
                <div class="dashboard-card">
                    <h2>Refer Friends</h2>
                    <p>Share your referral code and earn 70 credits for each signup!</p>
                    <div class="referral-code-box">
                        <input type="text" id="referralCode" readonly>
                        <button onclick="copyReferralCode()" class="btn btn-primary">Copy</button>
                    </div>
                </div>

                <!-- Download Card -->
                <div class="dashboard-card download-card">
                    <h2>Desktop Application</h2>
                    <p>Download the automation tool to start solving problems</p>
                    <button onclick="downloadApp()" class="btn btn-primary btn-large">
                        Download for Windows
                    </button>
                    <p class="download-note">Latest version: v1.0.0</p>
                </div>

                <!-- Payment Card -->
                <div class="dashboard-card">
                    <h2>Buy Credits</h2>
                    <p>Purchase credits to continue using the automation tool</p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="qrPayment()" class="btn btn-primary">
                            QR Payment
                        </button>
                    </div>
                </div>

                <!-- Usage Stats Card -->
                <div class="dashboard-card">
                    <h2>Usage Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value" id="totalProblems">0</span>
                            <span class="stat-label">Problems Solved</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="creditsUsed">0</span>
                            <span class="stat-label">Credits Used</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="dashboard-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Transaction History</h2>
                    <a href="transaction_history.html" class="btn btn-primary">View All Transactions</a>
                </div>
                <div id="recentTransactions">
                    <div class="loading">Loading recent transactions...</div>
                </div>
            </div>

            <!-- Admin Transaction Management -->
            <div class="dashboard-section" id="adminSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Admin - All UPI Transaction IDs</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="refreshAdminData()">Refresh</button>
                        <button class="btn btn-primary" onclick="exportTransactions()">Export CSV</button>
                    </div>
                </div>
                
                <!-- Admin Stats -->
                <div class="stats-grid" id="adminStats" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="value" id="adminTotalTransactions">0</div>
                        <div class="label">Total Transactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="adminSuccessfulTransactions">0</div>
                        <div class="label">Successful</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="adminPendingTransactions">0</div>
                        <div class="label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="adminTotalRevenue">â‚¹0</div>
                        <div class="label">Total Revenue</div>
                    </div>
                </div>

                <!-- Admin Filters -->
                <div class="filters" style="margin-bottom: 20px;">
                    <h3>Filters & Search</h3>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="adminStatusFilter">Status</label>
                            <select id="adminStatusFilter">
                                <option value="">All Status</option>
                                <option value="success">Success</option>
                                <option value="pending">Pending</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="filter-group" style="flex: 1; min-width: 200px;">
                            <label for="adminSearchInput">Search UPI Transaction ID</label>
                            <input type="text" id="adminSearchInput" placeholder="Enter UPI Transaction ID...">
                        </div>
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="applyAdminFilters()">Apply Filters</button>
                        </div>
                    </div>
                </div>

                <!-- Admin Transactions Table -->
                <div class="table-container">
                    <table class="usage-table" id="adminTransactionsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>UPI Transaction ID</th>
                                <th>User Email</th>
                                <th>Package</th>
                                <th>Amount</th>
                                <th>Credits</th>
                                <th>Status</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody id="adminTransactionsBody">
                            <tr>
                                <td colspan="8" class="loading">Loading admin transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Admin Pagination -->
                <div class="pagination" id="adminPagination" style="display: none;">
                    <button onclick="previousAdminPage()" id="adminPrevBtn">Previous</button>
                    <span id="adminPageInfo">Page 1 of 1</span>
                    <button onclick="nextAdminPage()" id="adminNextBtn">Next</button>
                </div>
            </div>

            <!-- Usage History -->
            <div class="dashboard-section">
                <h2>Recent Activity</h2>
                <div class="table-container">
                    <table class="usage-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Problem Type</th>
                                <th>Status</th>
                                <th>Credits Used</th>
                            </tr>
                        </thead>
                        <tbody id="usageHistory">
                            <tr>
                                <td colspan="4" class="no-data">No activity yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://ctautomationpro.onrender.com';
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user'));

        if (!token || !user) {
            window.location.href = 'login.html';
        }

        document.getElementById('userEmail').textContent = user.email;

        async function loadDashboard() {
            try {
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };

                const profileRes = await fetch(`${API_URL}/api/user/profile`, { headers });
                if (profileRes.ok) {
                    const profile = await profileRes.json();
                    document.getElementById('creditsBalance').textContent = profile.credits;
                    document.getElementById('referralCode').value = profile.referral_code;
                }

                const historyRes = await fetch(`${API_URL}/api/user/usage-history`, { headers });
                if (historyRes.ok) {
                    const history = await historyRes.json();
                    displayUsageHistory(history.logs);
                    updateStats(history.logs);
                }

                // Load recent transactions
                await loadRecentTransactions();
                
                // Load admin transactions if user is admin
                if (user.email === 'admin@codetantra.ac.in') {
                    await loadAdminTransactions();
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function displayUsageHistory(logs) {
            const tbody = document.getElementById('usageHistory');
            if (logs.length === 0) return;

            tbody.innerHTML = logs.slice(0, 10).map(log => `
                <tr>
                    <td>${new Date(log.created_at).toLocaleString()}</td>
                    <td>${log.problem_type}</td>
                    <td><span class="status ${log.success ? 'success' : 'failed'}">${log.success ? 'Success' : 'Failed'}</span></td>
                    <td>${log.credits_used}</td>
                </tr>
            `).join('');
        }

        function updateStats(logs) {
            const totalProblems = logs.filter(l => l.success).length;
            const creditsUsed = logs.reduce((sum, l) => sum + l.credits_used, 0);
            
            document.getElementById('totalProblems').textContent = totalProblems;
            document.getElementById('creditsUsed').textContent = creditsUsed;
        }

        async function loadRecentTransactions() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/qr-payment/history?page=1&limit=5`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayRecentTransactions(data.transactions);

            } catch (error) {
                console.error('Error loading recent transactions:', error);
                document.getElementById('recentTransactions').innerHTML = 
                    '<div class="error">Error loading transactions</div>';
            }
        }

        function displayRecentTransactions(transactions) {
            const container = document.getElementById('recentTransactions');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <p>No transactions yet</p>
                        <a href="qr_payment.html" class="btn btn-primary" style="margin-top: 10px;">Make a Payment</a>
                    </div>
                `;
                return;
            }

            const html = transactions.map(txn => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-secondary); margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">${txn.package_name}</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${txn.upi_transaction_id ? `TXN: ${txn.upi_transaction_id}` : `Order: ${txn.order_id}`}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: var(--success-color);">â‚¹${txn.amount}</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">${txn.credits} credits</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            ${new Date(txn.created_at).toLocaleDateString()}
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function copyReferralCode() {
            const codeInput = document.getElementById('referralCode');
            codeInput.select();
            document.execCommand('copy');
            alert('Referral code copied to clipboard!');
        }

        function downloadApp() {
            window.open('https://www.mediafire.com/file/4zhdhoo9ewjlo6d/CodetantraAutomationPro.7z/file', '_blank');
        }

        function qrPayment() {
            window.location.href = 'qr_payment.html';
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Admin functionality
        let adminCurrentPage = 1;
        let adminTotalPages = 1;
        let adminAllTransactions = [];

        async function loadAdminTransactions(page = 1) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/qr-payment/admin/transactions?page=${page}&limit=20`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        // Not admin, hide admin section
                        document.getElementById('adminSection').style.display = 'none';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                adminAllTransactions = data.transactions;
                adminCurrentPage = data.pagination.page;
                adminTotalPages = data.pagination.pages;

                displayAdminTransactions(data.transactions);
                updateAdminPagination(data.pagination);
                updateAdminStats(data.transactions);

                // Show admin section if user is admin
                document.getElementById('adminSection').style.display = 'block';

            } catch (error) {
                console.error('Error loading admin transactions:', error);
                document.getElementById('adminTransactionsBody').innerHTML = 
                    '<tr><td colspan="8" class="error">Error loading admin transactions</td></tr>';
            }
        }

        function displayAdminTransactions(transactions) {
            const tbody = document.getElementById('adminTransactionsBody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No transactions found</td></tr>';
                return;
            }

            const html = transactions.map(txn => `
                <tr>
                    <td>${txn.id}</td>
                    <td><span style="font-family: monospace; background: #374151; padding: 2px 6px; border-radius: 4px;">${txn.upi_transaction_id || 'N/A'}</span></td>
                    <td>${txn.user_email}</td>
                    <td>${txn.package_name}</td>
                    <td>â‚¹${txn.amount}</td>
                    <td>${txn.credits}</td>
                    <td><span class="status ${txn.status}">${txn.status}</span></td>
                    <td>${new Date(txn.created_at).toLocaleString()}</td>
                </tr>
            `).join('');

            tbody.innerHTML = html;
        }

        function updateAdminPagination(pagination) {
            const paginationDiv = document.getElementById('adminPagination');
            const pageInfo = document.getElementById('adminPageInfo');
            const prevBtn = document.getElementById('adminPrevBtn');
            const nextBtn = document.getElementById('adminNextBtn');

            if (pagination.pages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }

            paginationDiv.style.display = 'flex';
            pageInfo.textContent = `Page ${pagination.page} of ${pagination.pages}`;
            prevBtn.disabled = pagination.page <= 1;
            nextBtn.disabled = pagination.page >= pagination.pages;
        }

        function updateAdminStats(transactions) {
            const totalTxn = transactions.length;
            const successfulTxn = transactions.filter(txn => txn.status === 'success').length;
            const pendingTxn = transactions.filter(txn => txn.status === 'pending').length;
            const totalRevenue = transactions.reduce((sum, txn) => sum + txn.amount, 0);

            document.getElementById('adminTotalTransactions').textContent = totalTxn;
            document.getElementById('adminSuccessfulTransactions').textContent = successfulTxn;
            document.getElementById('adminPendingTransactions').textContent = pendingTxn;
            document.getElementById('adminTotalRevenue').textContent = `â‚¹${totalRevenue}`;
        }

        function previousAdminPage() {
            if (adminCurrentPage > 1) {
                loadAdminTransactions(adminCurrentPage - 1);
            }
        }

        function nextAdminPage() {
            if (adminCurrentPage < adminTotalPages) {
                loadAdminTransactions(adminCurrentPage + 1);
            }
        }

        function applyAdminFilters() {
            const statusFilter = document.getElementById('adminStatusFilter').value;
            const searchInput = document.getElementById('adminSearchInput').value.toLowerCase();

            let filteredTransactions = adminAllTransactions;

            if (statusFilter) {
                filteredTransactions = filteredTransactions.filter(txn => txn.status === statusFilter);
            }

            if (searchInput) {
                filteredTransactions = filteredTransactions.filter(txn => 
                    (txn.upi_transaction_id && txn.upi_transaction_id.toLowerCase().includes(searchInput)) ||
                    txn.user_email.toLowerCase().includes(searchInput) ||
                    txn.order_id.toLowerCase().includes(searchInput)
                );
            }

            displayAdminTransactions(filteredTransactions);
            updateAdminStats(filteredTransactions);
        }

        function refreshAdminData() {
            loadAdminTransactions(adminCurrentPage);
        }

        function exportTransactions() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "ID,UPI Transaction ID,User Email,Package,Amount,Credits,Status,Created\n" +
                adminAllTransactions.map(txn => 
                    `${txn.id},"${txn.upi_transaction_id || ''}","${txn.user_email}","${txn.package_name}",${txn.amount},${txn.credits},${txn.status},"${new Date(txn.created_at).toLocaleString()}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "transactions.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        loadDashboard();
    </script>
</body>
</html>

